
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost and Found Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
</head>

<body class="bg-gray-100">
    <div id="root" class="container mx-auto p-4"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const BASE_URL = 'http://127.0.0.1:8000';

        const LostFoundMatches = () => {
            const [user, setUser] = useState({ username: '', password: '', user_id: null });
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [accessToken, setAccessToken] = useState('');
            const [messageItems, setMessageItems] = useState([]);
            const [recipients, setRecipients] = useState([]);
            const [dashboardData, setDashboardData] = useState({
                lost_items: [], found_items: [], total_lost_items: 0, total_found_items: 0,
                total_ai_matches: 0, success_ratio: 0
            });
            const [claimData, setClaimData] = useState({});
            const [chatData, setChatData] = useState({ item_id: '', receiver_id: '', message: '' });
            const [chatThread, setChatThread] = useState([]);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');

            const checkAuth = () => {
                const token = localStorage.getItem('accessToken');
                if (token) {
                    setAccessToken(token);
                    setIsAuthenticated(true);
                    console.log('Access token found:', token);
                } else {
                    console.log('No access token found');
                }
            };

            const fetchDashboard = async () => {
                if (!accessToken) {
                    console.error('No access token available');
                    setError('Please login again to access the dashboard');
                    setIsAuthenticated(false);
                    return;
                }
                try {
                    const response = await axios.get(`${BASE_URL}/api/dashboard/`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    console.log('Dashboard response:', response.data);
                    setDashboardData(response.data);
                    setError('');
                } catch (err) {
                    console.error('Dashboard fetch error:', err.response?.data || err);
                    if (err.response?.status === 401) {
                        setError('Session expired. Please login again.');
                        setIsAuthenticated(false);
                        localStorage.removeItem('accessToken');
                    } else {
                        setError('Failed to load dashboard: ' + (err.response?.data?.detail || err.message));
                    }
                }
            };

            const fetchMessageItems = async () => {
                if (!accessToken) {
                    console.error('No access token available');
                    return;
                }
                try {
                    const response = await axios.get(`${BASE_URL}/api/my-messages/items/`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    console.log('Message items response:', response.data);
                    setMessageItems(response.data);
                    setError('');
                } catch (err) {
                    console.error('Error fetching message items:', err.response?.data || err);
                    if (err.response?.status === 401) {
                        setError('Session expired. Please login again.');
                        setIsAuthenticated(false);
                        localStorage.removeItem('accessToken');
                    } else {
                        setError('Failed to load message items');
                    }
                }
            };

            const fetchRecipients = async (itemId) => {
                if (!accessToken || !itemId) {
                    console.log('fetchRecipients skipped: no token or itemId', { accessToken, itemId });
                    setRecipients([]);
                    setChatData(prev => ({ ...prev, receiver_id: '' }));
                    return;
                }
                try {
                    console.log('Fetching recipients for itemId:', itemId);
                    const response = await axios.get(`${BASE_URL}/api/my-messages/recipients/${itemId}/`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (!Array.isArray(response.data)) {
                        console.error('Invalid recipients response:', response.data);
                        setError('Invalid recipients data from server');
                        setRecipients([]);
                        return;
                    }
                    const validRecipients = response.data.filter(user => user.id && Number.isInteger(user.id));
                    setRecipients(validRecipients);
                    console.log('Valid recipients for item', itemId, ':', validRecipients);
                    if (validRecipients.length === 1) {
                        const recipientId = String(validRecipients[0].id);
                        setChatData(prev => ({ ...prev, item_id: String(itemId), receiver_id: recipientId }));
                        console.log('Auto-selected recipient:', recipientId);
                        fetchChatThread(itemId, recipientId);
                    } else {
                        setChatData(prev => ({ ...prev, item_id: String(itemId), receiver_id: '' }));
                    }
                } catch (err) {
                    console.error('Error fetching recipients:', err.response?.data || err);
                    setError('Failed to load recipients: ' + (err.response?.data?.error || err.message));
                    setRecipients([]);
                    setChatData(prev => ({ ...prev, receiver_id: '' }));
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const response = await axios.post(`${BASE_URL}/api/login/`, {
                        username: user.username,
                        password: user.password
                    });
                    console.log('Login response:', response.data);
                    const token = response.data.access;
                    localStorage.setItem('accessToken', token);
                    setAccessToken(token);
                    setUser({ ...user, user_id: response.data.user_id });
                    setIsAuthenticated(true);
                    setError('');
                    console.log('Access Token set:', token);
                } catch (err) {
                    console.error('Login error:', err.response?.data || err);
                    setError('Invalid credentials');
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                try {
                    const response = await axios.post(`${BASE_URL}/api/register/`, {
                        username: user.username,
                        email: `${user.username}@example.com`,
                        password: user.password
                    });
                    setSuccess('Registration successful. Please login.');
                    setError('');
                    console.log('Registration successful:', response.data);
                } catch (err) {
                    console.error('Registration error:', err.response?.data || err);
                    setError('Registration failed');
                }
            };

            const handleClaimSubmit = async (e, itemId) => {
                e.preventDefault();
                if (!accessToken) {
                    setError('Please login again to submit a claim');
                    setIsAuthenticated(false);
                    return;
                }
                const claimNote = claimData[itemId] || '';
                if (!claimNote) {
                    setError('Claim note is required');
                    return;
                }
                try {
                    const response = await axios.post(`${BASE_URL}/api/claim/${itemId}/`, {
                        claim_note: claimNote
                    }, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    setSuccess(response.data.message);
                    setError('');
                    setClaimData(prev => ({ ...prev, [itemId]: '' }));
                    console.log('Claim response:', response.data);
                    fetchDashboard();
                    fetchMessageItems();
                } catch (err) {
                    console.error('Claim error:', err.response?.data || err);
                    setError('Failed to submit claim: ' + (err.response?.data?.error || err.message));
                }
            };

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!accessToken) {
                    setError('Please login again to send a message');
                    setIsAuthenticated(false);
                    return;
                }
                if (!chatData.message.trim()) {
                    setError('Message cannot be empty');
                    console.log('Chat submit failed: empty message');
                    return;
                }
                if (!chatData.item_id || !chatData.receiver_id || isNaN(parseInt(chatData.receiver_id))) {
                    setError('Please select a valid item and recipient');
                    console.log('Chat submit failed: invalid item_id or receiver_id', chatData);
                    return;
                }
                const payload = {
                    item: parseInt(chatData.item_id),
                    receiver: parseInt(chatData.receiver_id),
                    message: chatData.message.trim()
                };
                console.log('Chat payload:', JSON.stringify(payload));
                try {
                    const response = await axios.post(`${BASE_URL}/api/messages/`, payload, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    setSuccess('Message sent successfully');
                    setError('');
                    setChatData({ item_id: '', receiver_id: '', message: '' });
                    setRecipients([]);
                    console.log('Message response:', response.data);
                    fetchChatThread(chatData.item_id, chatData.receiver_id);
                } catch (err) {
                    console.error('Chat error:', err.response?.data || err);
                    setError('Failed to send message: ' + JSON.stringify(err.response?.data || err.message));
                }
            };

            const fetchChatThread = async (item_id, receiver_id) => {
                if (!accessToken || !item_id || !receiver_id || isNaN(parseInt(receiver_id))) {
                    setError('Please select an item and valid recipient to view chat');
                    console.log('fetchChatThread failed: invalid parameters', { item_id, receiver_id });
                    return;
                }
                try {
                    console.log('Fetching chat thread for item_id:', item_id, 'receiver_id:', receiver_id);
                    const response = await axios.get(`${BASE_URL}/api/chat/?item_id=${item_id}&receiver_id=${receiver_id}`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    setChatThread(response.data);
                    console.log('Chat thread:', response.data);
                } catch (err) {
                    console.error('Chat thread error:', err.response?.data || err);
                    setError('Failed to load chat thread: ' + (err.response?.data?.detail || err.message));
                }
            };

            const handleConnect = async (itemId) => {
                if (!itemId) {
                    console.error('handleConnect: itemId is undefined');
                    setError('Invalid item selected');
                    return;
                }
                if (!accessToken) {
                    console.error('No access token available');
                    setError('Please login again to send a message');
                    setIsAuthenticated(false);
                    return;
                }
                try {
                    console.log('handleConnect: Fetching recipients for itemId:', itemId);
                    const response = await axios.get(`${BASE_URL}/api/my-messages/recipients/${itemId}/`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (!Array.isArray(response.data)) {
                        console.error('Invalid recipients response:', response.data);
                        setError('Invalid recipients data from server');
                        setRecipients([]);
                        return;
                    }
                    const validRecipients = response.data.filter(user => user.id && Number.isInteger(user.id));
                    setRecipients(validRecipients);
                    console.log('Valid recipients for item', itemId, ':', validRecipients);
                    if (validRecipients.length > 0) {
                        const recipientId = String(validRecipients[0].id);
                        setChatData({ item_id: String(itemId), receiver_id: recipientId, message: '' });
                        console.log('Auto-selected recipient:', recipientId);
                        fetchChatThread(itemId, recipientId);
                    } else {
                        setChatData({ item_id: String(itemId), receiver_id: '', message: '' });
                        console.log('No recipients available for item:', itemId);
                    }
                } catch (err) {
                    console.error('Error fetching recipients for connect:', err.response?.data || err);
                    setError('Failed to load recipients: ' + (err.response?.data?.error || err.message));
                    setRecipients([]);
                    setChatData({ item_id: String(itemId), receiver_id: '', message: '' });
                }
            };

            useEffect(() => {
                checkAuth();
                if (isAuthenticated && accessToken) {
                    fetchDashboard();
                    fetchMessageItems();
                }
            }, [isAuthenticated, accessToken]);

            return (
                <div className="max-w-7xl mx-auto">
                    {!isAuthenticated ? (
                        <div className="bg-white p-6 rounded-lg shadow-md">
                            <h2 className="text-2xl font-bold mb-4">Login or Register</h2>
                            {error && <p className="text-red-500">{error}</p>}
                            {success && <p className="text-green-500">{success}</p>}
                            <form onSubmit={handleLogin} className="mb-4">
                                <input
                                    type="text"
                                    placeholder="Username"
                                    value={user.username}
                                    onChange={(e) => setUser({ ...user, username: e.target.value })}
                                    className="w-full p-2 mb-2 border rounded"
                                />
                                <input
                                    type="password"
                                    placeholder="Password"
                                    value={user.password}
                                    onChange={(e) => setUser({ ...user, password: e.target.value })}
                                    className="w-full p-2 mb-2 border rounded"
                                />
                                <button type="submit" className="bg-blue-500 text-white p-2 rounded">Login</button>
                            </form>
                            <form onSubmit={handleRegister}>
                                <button type="submit" className="bg-green-500 text-white p-2 rounded">Register</button>
                            </form>
                        </div>
                    ) : (
                        <div>
                            <h2 className="text-2xl font-bold mb-4">Lost and Found Dashboard</h2>
                            <div className="flex space-x-4 mb-6">
                                <a href="/report-lost" className="bg-blue-500 text-white p-2 rounded">Report Lost</a>
                                <a href="/report-found" className="bg-blue-500 text-white p-2 rounded">Report Found</a>
                                <a href="/ai-matches" className="bg-blue-500 text-white p-2 rounded">AI Matches</a>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                                <h3 className="text-xl font-semibold mb-4">Dashboard Metrics</h3>
                                {dashboardData ? (
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <p><strong>Total Reported Lost Items:</strong> {dashboardData.total_lost_items || 0}</p>
                                            <p><strong>Total Reported Found Items:</strong> {dashboardData.total_found_items || 0}</p>
                                        </div>
                                        <div>
                                            <p><strong>Total AI Matches:</strong> {dashboardData.total_ai_matches || 0}</p>
                                            <p><strong>Success Ratio:</strong> {dashboardData.success_ratio ? dashboardData.success_ratio.toFixed(2) : 0}%</p>
                                        </div>
                                    </div>
                                ) : (
                                    <p>Loading metrics...</p>
                                )}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-xl font-semibold mb-4">Lost Items (Last 24 Hours)</h3>
                                    {dashboardData.lost_items.map(item => (
                                        <div key={item.id} className="mb-4 p-4 border rounded">
                                            <p><strong>Title:</strong> {item.title}</p>
                                            <p><strong>Location:</strong> {item.location}</p>
                                            <p><strong>Description:</strong> {item.description}</p>
                                            <p><strong>Category:</strong> {item.category?.name || 'N/A'}</p>
                                            {item.image && <img src={item.image} alt="Item" className="w-32 h-32 object-cover mt-2" />}
                                            {item.status === 'claimed' && item.has_approved_claim && (
                                                <button
                                                    onClick={() => handleConnect(item.id)}
                                                    className="bg-purple-500 text-white p-2 rounded mt-2"
                                                >
                                                    Connect with Claimer
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <h3 className="text-xl font-semibold mb-4">Found Items (Last 24 Hours)</h3>
                                    {dashboardData.found_items.map(item => (
                                        <div key={item.id} className="mb-4 p-4 border rounded">
                                            <p><strong>Title:</strong> {item.title}</p>
                                            <p><strong>Location:</strong> {item.location}</p>
                                            <p><strong>Description:</strong> {item.description}</p>
                                            <p><strong>Category:</strong> {item.category?.name || 'N/A'}</p>
                                            {item.image && <img src={item.image} alt="Item" className="w-32 h-32 object-cover mt-2" />}
                                            <div className="flex space-x-2 mt-2">
                                                <form onSubmit={(e) => handleClaimSubmit(e, item.id)} className="flex-1">
                                                    <input
                                                        type="text"
                                                        placeholder="Enter claim note"
                                                        value={claimData[item.id] || ''}
                                                        onChange={(e) => setClaimData({ ...claimData, [item.id]: e.target.value })}
                                                        className="w-full p-2 mb-2 border rounded"
                                                    />
                                                    <button type="submit" className="bg-green-500 text-white p-2 rounded">Claim Item</button>
                                                </form>
                                                {item.status === 'claimed' && item.has_approved_claim && (
                                                    <button
                                                        onClick={() => handleConnect(item.id)}
                                                        className="bg-purple-500 text-white p-2 rounded"
                                                    >
                                                        Connect with Claimer
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow-md mt-6">
                                <h3 className="text-xl font-semibold mb-4">Chat</h3>
                                {error && <p className="text-red-500">{error}</p>}
                                {success && <p className="text-green-500">{success}</p>}
                                <form onSubmit={handleChatSubmit} className="mb-4">
                                    <select
                                        value={chatData.item_id}
                                        onChange={(e) => {
                                            const itemId = e.target.value;
                                            console.log('Selected item_id:', itemId);
                                            setChatData({ ...chatData, item_id: itemId, receiver_id: '' });
                                            setRecipients([]);
                                            if (itemId) fetchRecipients(itemId);
                                        }}
                                        className="w-full p-2 mb-2 border rounded"
                                    >
                                        <option value="">Select Item</option>
                                        {messageItems.map(item => (
                                            <option key={item.id} value={item.id}>{item.title} ({item.status})</option>
                                        ))}
                                    </select>
                                    <div className="flex items-center mb-2">
                                        <select
                                            value={chatData.receiver_id}
                                            onChange={(e) => {
                                                const value = e.target.value;
                                                console.log('Selected receiver_id:', value);
                                                setChatData({ ...chatData, receiver_id: value });
                                                if (value && chatData.item_id && Number.isInteger(parseInt(value))) {
                                                    fetchChatThread(chatData.item_id, value);
                                                }
                                            }}
                                            className="w-full p-2 border rounded"
                                            disabled={!chatData.item_id || recipients.length === 0}
                                        >
                                            <option value="">
                                                {recipients.length === 0 && chatData.item_id
                                                    ? 'No recipients available'
                                                    : 'Select Recipient'}
                                            </option>
                                            {recipients.map(user => (
                                                <option key={user.id} value={String(user.id)}>
                                                    {user.username} (ID: {user.id})
                                                </option>
                                            ))}
                                        </select>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                console.log('Refresh recipients clicked for item_id:', chatData.item_id);
                                                if (chatData.item_id) fetchRecipients(chatData.item_id);
                                            }}
                                            className="ml-2 bg-gray-300 text-black p-2 rounded"
                                            disabled={!chatData.item_id}
                                        >
                                            Refresh Recipients
                                        </button>
                                    </div>
                                    <textarea
                                        placeholder="Message"
                                        value={chatData.message}
                                        onChange={(e) => setChatData({ ...chatData, message: e.target.value })}
                                        className="w-full p-2 mb-2 border rounded"
                                    />
                                    <button
                                        type="submit"
                                        className={`bg-blue-500 text-white p-2 rounded ${(!chatData.item_id || !chatData.receiver_id || !chatData.message.trim() || isNaN(parseInt(chatData.receiver_id))) ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        disabled={!chatData.item_id || !chatData.receiver_id || !chatData.message.trim() || isNaN(parseInt(chatData.receiver_id))}
                                    >
                                        Send Message
                                    </button>
                                </form>
                                <div>
                                    {chatThread.map(message => (
                                        <div key={message.id} className="mb-2 p-2 border rounded">
                                            <p><strong>{message.sender_username}:</strong> {message.message}</p>
                                            <p className="text-sm text-gray-500">{new Date(message.timestamp).toLocaleString()}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<LostFoundMatches />, document.getElementById('root'));
    </script>
</body>

</html>
